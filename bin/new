#!/bin/bash
##------------------------------------------------------------------------------
##
##        ██████╗██████╗  ██████╗██████╗ ███████╗ █████╗ ██████╗ ██╗   ██╗
##       ██╔════╝██╔══██╗██╔════╝██╔══██╗██╔════╝██╔══██╗██╔══██╗╚██╗ ██╔╝
##       ██║     ██████╔╝██║     ██████╔╝█████╗  ███████║██║  ██║ ╚████╔╝ 
##       ██║     ██╔═══╝ ██║     ██╔══██╗██╔══╝  ██╔══██║██║  ██║  ╚██╔╝  
##       ╚██████╗██║     ╚██████╗██║  ██║███████╗██║  ██║██████╔╝   ██║   
##        ╚═════╝╚═╝      ╚═════╝╚═╝  ╚═╝╚══════╝╚═╝  ╚═╝╚═════╝    ╚═╝   
##
##-----------------------------LICENSE NOTICE------------------------------------
##  This file is part of CPCReady Basic programation.
##  Copyright (C) 2024 Destroyer
##
##  This program is free software: you can redistribute it and/or modify
##  it under the terms of the GNU Lesser General Public License as published by
##  the Free Software Foundation, either version 3 of the License, or
##  (at your option) any later version.
##
##  This program is distributed in the hope that it will be useful,
##  but WITHOUT ANY WARRANTY; without even the implied warranty of
##  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
##  GNU Lesser General Public License for more details.
##
##  You should have received a copy of the GNU Lesser General Public License
##  along with this program.  If not, see <http://www.gnu.org/licenses/>.
##------------------------------------------------------------------------------

## Bash Include files
source $(dirname "$0")/lib/library.sh

# Function to display help message
function show_help {
    
    CPCREADY
    echo "Create new CPCReady project."
    echo 
    echo "Use: $(basename "$0") [option]"
    echo "  -h, --help     Show this help message."
    echo "  -v, --version  Show version this software."
    ready
}

# Check if the help parameter is provided
case $1 in
    -v|--version)
        show_version
        ready
        exit 0
        ;;
    -h|--help)
        show_help
        exit 0
        ;;
esac

## Show logo
CPCREADY

PRINT "TITLE" "Create New Project."

if [ -e ./"$CONFIG_CPCREADY" ]; then
    echo
    PRINT "ERROR_NO_EXIT" "The "$CONFIG_CPCREADY" file exists in the current path."
    ready
    exit
fi

while true; do
    echo
    read -p "${BLUE}${BOLD}  Project's name: ${NORMAL}" project_name

    # Reemplazar espacios por guiones bajos
    project_name=${project_name// /_}

    if [[ -z "$project_name" ]]; then
        echo
        PRINT "ERROR_NO_EXIT" "The project name cannot be empty."
    elif [[ -d "./$project_name" ]]; then
        echo
        PRINT "ERROR_NO_EXIT" "A directory with the name '$project_name' already exists. Please choose another name."
    else
        break
    fi
done
while true; do
    read -p "${BLUE}${BOLD}  CPC Model (464, 6128, or 664): ${NORMAL}" cpc_model

    case $cpc_model in
        464|6128|664)
            break
            ;;
        *)
            echo
            PRINT "ERROR_NO_EXIT" "Invalid CPC Model. Please choose either 464, 664, or 6128."
            ready
            echo
            ;;
    esac
done

while true; do
    read -p "${BLUE}${BOLD}  Apply native Amstrad CPC colors to the Visual Studio Code terminal? (y/n): " respuesta
    case $respuesta in
        [Yy]* ) AMSTRAD_COLORS="S";break;;
        [Nn]* ) AMSTRAD_COLORS="N";break;;
        * ) echo "${RED}${BOLD}  Please respond with 'y' or 'n'.";;
    esac
done

# while true; do
#     read -p "${BLUE}${BOLD}  Los test se realizarán en (M4 / DISC): " respuesta
#     case "$respuesta" in
#         [Mm]4*|[Bb]oard*)  TEST="M4";break;;
#         [Dd][Ii][Ss][Cc]*) TEST="DISC";break;;
#         *) echo "${RED}${BOLD}  Please respond with 'M4' or 'DISC'.";;
#     esac
# done

## Create the project directory
PRINT "TAG" "Directory"
mkdir -p "$project_name/$IN_BAS"
mkdir -p "$project_name/$OUT"
mkdir -p "$project_name/$OUT_DISC"
mkdir -p "$project_name/$PATH_CONFIG_PROJECT"
PRINT "OK" "Create the $project_name directory."

## Create Templates files
PRINT "TAG" "Template File"
cp -r "$CPCREADY/cfg/templates/DISC.BAS" "$project_name/$IN_BAS/DISC.BAS"
PRINT "OK" "Create template example DISC.BAS file."

## Create configuration file
PRINT "TAG" "Configurations"

touch "$project_name/$PATH_CONFIG_PROJECT/$CONFIG_CPCREADY"
cp -r "$CPCREADY/cfg/templates/$CONFIG_CPCEMU" "$project_name/$PATH_CONFIG_PROJECT/$CONFIG_CPCEMU"

case $cpc_model in
    "464")
        MODEL=0
        ;;
    "664")
        MODEL=1
        ;;
    "6128")
        MODEL=2
        ;;
    *)
        PRINT ERROR "CPC model $1 is not supported."
        ;;
esac

configuration "$PWD/$project_name/$PATH_CONFIG_PROJECT/$CONFIG_CPCEMU" CPC_TYPE $MODEL
configuration "$PWD/$project_name/$PATH_CONFIG_PROJECT/$CONFIG_CPCREADY" MODEL $cpc_model
PRINT OK "Configurate CPC Model $cpc_model"

configuration "$PWD/$project_name/$PATH_CONFIG_PROJECT/$CONFIG_CPCEMU" M4_SD_PATH "$PWD/$project_name/$OUT"
PRINT OK "Configurate M4 Board Directory $OUT"

configuration "$PWD/$project_name/$PATH_CONFIG_PROJECT/$CONFIG_CPCEMU" DRIVE_A "$PWD/$project_name/$OUT_DISC"
configuration "$PWD/$project_name/$PATH_CONFIG_PROJECT/$CONFIG_CPCEMU" DRIVE_B "$PWD/$project_name/$OUT_DISC"
configuration "$PWD/$project_name/$PATH_CONFIG_PROJECT/$CONFIG_CPCREADY" DISC "$project_name.dsk"
PRINT OK "Configurate DISC Directory $OUT_DISC"

# creamos vscode para cambios de color de la terminal.
if [ "$AMSTRAD_COLORS" = "S" ]; then
    mkdir -p "$project_name/.vscode"
    cp -r "$CPCREADY/cfg/templates/settings.json" "$project_name/.vscode/settings.json"
    PRINT "OK" "Apply colors to the Vscode terminal."
fi

configuration "$PWD/$project_name/$PATH_CONFIG_PROJECT/$CONFIG_CPCREADY" MODE 1

PRINT OK "Configure test execution with $TEST"

## Create image disk file
create_dsk "$PWD/$project_name/$OUT_DISC/$project_name.dsk"

PRINT "TITLE" "Project Created Successfully"

ready